<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>WebSocket</title>
</head>
<body>
<h1>WebSocket RabbitMQ demo</h1>
<div style="width: 800px;margin: 0 auto;">
    <fieldset>
        <legend>连接websocket</legend>
        <section>
            <button id="connect">连接</button>
        </section>
    </fieldset>
    <fieldset>
        <legend>设置订阅地址</legend>
        <section>
            <label>订阅地址：</label>
            <select id="subscribe-uri">
                <option></option>
                <option value="/exchange/ws.rabbit.exchange.topic/animal.#">
                    /exchange/ws.rabbit.exchange.topic/animal.#
                </option>
                <option value="/exchange/ws.rabbit.exchange.topic/animal.*">
                    /exchange/ws.rabbit.exchange.topic/animal.*
                </option>
            </select>
            <button id="subscribe" disabled>订阅</button>
        </section>
    </fieldset>
    <fieldset>
        <legend>直接发送到MQ</legend>
        <section>
            <em>用来测试将消息发送到mq，各个客户端的接收情况</em><br>
            <label>routing key：</label>
            <select id="routingKey">
                <option></option>
                <option value="animal.#">animal.#</option>
                <option value="animal.*">animal.*</option>
            </select>
            <label>消息内容：</label>
            <input id="contentMq" style="width: 40%;"/>
            <button id="send2mq">发送到mq</button>
        </section>
    </fieldset>
    <fieldset>
        <legend>发送消息</legend>
        <section>
            <label>消息内容：</label>
            <input id="content" style="width: 100%; height: 50px;"/>
            <button id="send1">send2mifei</button>
            <button id="send2">send2peppa</button>
            <br>
            <label>收到的消息：</label>
            <div id="message" style="border: 1px solid #eee;min-height: 100px;background-color: #eee"></div>
        </section>
    </fieldset>
    <fieldset>
        <legend>收到的错误信息</legend>
        <section>
            <label>错误信息：</label>
            <div id="error" style="border: 1px solid wheat;min-height: 100px;background-color: wheat"></div>
        </section>
    </fieldset>
</div>

<!--jquery-->
<script src="https://cdn.bootcss.com/jquery/2.1.0/jquery.min.js"></script>
<!--stomp js-->
<script src="https://cdn.bootcss.com/stomp.js/2.3.3/stomp.js"></script>
<!--sockjs-client-->
<script src="https://cdn.bootcss.com/sockjs-client/1.4.0/sockjs.js"></script>
<script type="application/javascript">
    var ws;
    $(function () {
        var $connect = $('#connect');
        var $subscribeUri = $('#subscribe-uri');
        var $subscribe = $('#subscribe');
        var $send1 = $('#send1');
        var $send2 = $('#send2');
        var $message = $('#message');
        var $content = $('#content');
        var $error = $('#error');
        var $routingKey = $('#routingKey');
        var $contentMq = $('#contentMq');
        var $send2mq = $('#send2mq');
        var connected = false;

        $connect.click(function () {
            if (connected) {
                disconnect();
            } else {
                connect();
            }
        });

        $subscribe.click(function () {
            if ($subscribeUri.val())
                showMessage('已经订阅：' + $subscribeUri.val());
            // 订阅聊天内容
            ws.subscribe($subscribeUri.val(), function (data) {
                showMessage(data.body);
            });
        });

        $send1.click(function () {
            if ($content.val())
                send1();
        });

        $send2.click(function () {
            if ($content.val())
                send2();
        });

        $send2mq.click(function () {
            if ($contentMq.val())
                $.post('/send2mq', {
                    routingkey: $routingKey.val(),
                    content: $contentMq.val()
                }, function (d) {
                    console.log(d);
                });
        });

        function send1() {
            ws.send('/app/send2mifei', {}, $content.val());
        }

        function send2() {
            ws.send('/app/send2peppa', {}, $content.val());
        }

        function connect() {
            var socket = new SockJS('/websocket');
            ws = Stomp.over(socket);
            // 传递header信息，用来后台登录认证
            ws.connect({}, function (frame) {
                setConnected(true);
                console.log("connected : " + frame);
                // 订阅错误信息
                ws.subscribe('/queue/errors', function (data) {
                    console.log("error : " + data);
                    showError(data.body);
                });
            }, function (error) {
                console.log("STOMP error : " + error);
            });
        }

        function disconnect() {
            if (ws != null) {
                ws.disconnect();
            }
            setConnected(false);
        }

        function setConnected(b) {
            connected = b;
            if (b) {
                $subscribe.removeAttr('disabled');
                $connect.text('退出');
            } else {
                $subscribe.attr('disabled', true);
                $connect.text('连接');
            }
        }

        function showMessage(message) {
            $message.append("<br>" + message);
        }

        function showError(message) {
            $error.append("<br>" + message);
        }
    });
</script>
</body>
</html>